<!DOCTYPE html>
<html>
<head>
    <title>Hand Gesture Car Control</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #video-container { position: absolute; bottom: 10px; right: 10px; width: 200px; border: 2px solid white; border-radius: 10px; overflow: hidden; z-index: 10; display: none; } 
        #webcam { width: 100%; transform: scaleX(-1); }
        #status { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; }
        #gesture-toggle { position: absolute; top: 70px; left: 20px; z-index: 20; padding: 10px 20px; background: #00ffcc; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="status">Cursor Mode (Gesture OFF)</div>
    <button id="gesture-toggle">Turn Gestures ON</button>

    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let car;
        let gesturesEnabled = false; 
        
        // --- SCALE SMOOTHING VARIABLES ---
        let targetScale = 1.0;  // Start at normal size
        let currentScale = 1.0;

        const status = document.getElementById('status');
        const toggleBtn = document.getElementById('gesture-toggle');
        const videoContainer = document.getElementById('video-container');

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; 
        controls.dampingFactor = 0.05;

        const light = new THREE.DirectionalLight(0xffffff, 2);
        light.position.set(2, 2, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        const loader = new GLTFLoader();
        loader.load('humanbrain1.glb', (gltf) => {
            car = gltf.scene;
            // Set initial scale to something visible
            car.scale.set(1, 1, 1); 
            scene.add(car);
            status.innerText = "Model Loaded. Cursor mode active.";
        });

        const videoElement = document.getElementById('webcam');
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults((results) => {
            if (gesturesEnabled && results.multiHandLandmarks && results.multiHandLandmarks.length > 0 && car) {
                const hand = results.multiHandLandmarks[0];
                
                // SMOOTH ROTATION
                const targetRotation = (hand[0].x - 0.5) * 5; 
                car.rotation.y = THREE.MathUtils.lerp(car.rotation.y, targetRotation, 0.08);
                const targetTilt = (hand[0].y - 0.5) * 2;
                car.rotation.x = THREE.MathUtils.lerp(car.rotation.x, targetTilt, 0.08);

                // SMOOTH SCALE (Mapped to be much larger)
                const pinchDist = Math.hypot(hand[4].x - hand[8].x, hand[4].y - hand[8].y);
                
                // Map pinch distance (0.05 to 0.3) to scale (0.5 to 2.5)
                // INCREASE the 2.5 below if it is still too small!
                targetScale = THREE.MathUtils.mapLinear(pinchDist, 0.05, 0.3, 0.5, 2.5);

                status.innerText = "Hand Detected - Controlling Model";
            }
        });

        const cameraFeed = new Camera(videoElement, {
            onFrame: async () => { 
                if (gesturesEnabled) await hands.send({image: videoElement}); 
            },
            width: 640, height: 480 
        });

        toggleBtn.addEventListener('click', () => {
            gesturesEnabled = !gesturesEnabled;
            if (gesturesEnabled) {
                toggleBtn.innerText = "Turn Gestures OFF";
                toggleBtn.style.background = "#ff4444";
                videoContainer.style.display = "block";
                cameraFeed.start();
            } else {
                toggleBtn.innerText = "Turn Gestures ON";
                toggleBtn.style.background = "#00ffcc";
                videoContainer.style.display = "none";
                status.innerText = "Cursor Mode (Gesture OFF)";
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            
            if (car) {
                // Smoothing the scale transition
                currentScale = THREE.MathUtils.lerp(currentScale, targetScale, 0.05);
                car.scale.set(currentScale, currentScale, currentScale);
            }

            if (controls) controls.update(); 
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>